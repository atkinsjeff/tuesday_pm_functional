---
title: "Functionazling Rasters From NEON"
author: "Jeff Atkins"
date: "June 21, 2016"
output: html_document
---


Start by putting up objectives/tasks that students will be working though:

1. Import a raster — A lidar canopy height model (lidar/Teak_lidarCHM.tif)
1. For the CHM, set values == 0 to NA (not trees)
1. classify the raster according to some distribution – low medium and tall trees. This could be done using a histogram potentially or we could just decide that <2m is generally grasses / understory, <6m small trees,and the rest are tall trees. A function could import the desired thresholds. Visualize histogram/density and plot vertical cutoff lines.

1. PLOT - layer the classified raster on top of the hillshade, add a legend for each “class” - legends are super tricky to simplifying this process with a function would be good.  see: http://neon-workwithdata.github.io/neon-data-institute-2016/R/classify-by-threshold-R/  for my take on forcing a legend outside of the plot area using par settings. You may have other better forms of magic to make this work well. :)

1. Export the plot figure to a pdf – publishable
1. Export the classified raster as a geotiff with NaFlagg = -9999 to an outputs folder.

```{r set-library }
library(raster)
library(rgdal)
library(magrittr)
```

## Step One: Import Raster

```{r import-raster}

#### PARAMETERS
chm_file <-r("../NEONdata/D17-California/TEAK/2013/lidar/Teak_lidarCHM.tif")

# Threshold breaks for canopy height in (m)
chosen.breaks <- c(6, 30, 50, 100)



chm <- raster(chm_file)

#quick sanity check
plot(chm,
     main="Canopy Height \n LowerTeakettle, California")
```

## Step Two:  Set values == 0 to NA (not trees)  

```{r set-values-NA}
#Sets those 0s to NA
chm[ chm <= 0 ] <- NA

```


```{r functions-generalized}

###############
# Density plot function from chm
density_plot_from_chm <- function(chm, title, bins) {
     density(chm, main = title, xlab = "Canopy height (m)")
     sapply(bins, function(x) abline(v = x, col = "red"))
}

# Histogram plot function, expects chm raster, title, and breaks
hist_plot_from_chm <- function(chm, title, bins) {
     #chm[ chm <= 0 ] <- NA
     hist(chm, main = title, xlab = "Canopy height (m)")
     sapply(bins, function(x) abline(v = x, col = "red"))
}
 

# Let's start a function that reclassifies a matrix from a set of breaks
create_height_class_matrix <- function(breaks) {
     # get the length of the breaks vector to figure out how many classes we have
     br.length <- length(breaks)
     
     # Initialize height class vector with 0
     height.class.m <- c(0)
     
     # for inputs of breaks that  = c(6, 30, 50)
     # We'd like to make something like this:
     
     # c(0, 6, 1,
     #   6, 30, 2,
     #   30, 50, 3,
     #   50, 1000, 4)
     
     for(i in 1:br.length) {
          height.class.m <- c(height.class.m, breaks[i - 1], breaks[i], i)
     }
     reclass.height.matrix <- matrix(height.class.m,
                                ncol = 3,
                                byrow = TRUE)
     reclass.height.matrix
}

##########################################
##########################################
# function to plot the reclassified raster

plot_reclassified_raster <- function(rast.in, site.name, breaks){
        # this is a tricky bit because we need to out the legend
        # outside of the plot region
        
        # Get colors for plotting
        bin.colors <- rev(terrain.colors(length(breaks)))
        
        # make room for a legend
        
        par(xpd = FALSE, mar = c(5.1, 4.1, 4.1, 4.5))
        
        # plot
        plot(rast.in,
                 col = bin.colors,
                 main = paste("Canopy height classes \n", site.name),
                 legend = FALSE)
        
        # allow legend to plot outside of bounds
        par(xpd = TRUE)
        
        # legend x
        leg.x <- par()$usr[2] + 20
        
        # legend y
        leg.y <- par()$usr[4] + 50 - (abs(par()$usr[3] - par()$usr[4]) / 2) 
        
        # create legend text
        height.mat <- create_height_class_matrix(breaks)
        
        # initialize legend text
        legend.text <- c()
        
        for (i in 1:length(breaks)) {
                
                legend.text <- c(legend.text, 
                                                 paste0(height.mat[i, 1], "-", 
                                                            height.mat[i, 2], " m"))
        }
        
        # create the legend
        legend(leg.x, leg.y,  # set x,y legend location
                   legend = legend.text,  # make sure the order matches colors
                   fill = bin.colors,
                   bty = "n") # turn off border
        
        # turn off plotting outside of bounds
        par(xpd = FALSE)
}


##### Make PDF function
make_pdf <- function(expr, filename, ..., verbose = TRUE) {
     if(verbose){
          message("Creating: ", filename)
     }
     pdf(file = filename, ...)
     on.exit(dev.off())
     eval.parent(substitute(expr))
}




```

## Step Three:  Raster Classification By Height

```{r raster-height-classify}
#lets do a histogram and get some distribution
hist(chm)
density(chm)

#############
#############










density_plot_from_chm(chm, "Teakettle!", chosen.breaks)



reclassify.mat <- create_height_class_matrix(chosen.breaks)

reclassified.chm <- reclassify(chm, reclassify.mat)




make_pdf(density_plot_from_chm(reclassified.chm, 
                               title = "Canopy heights for NEON TeaKettle",
         breaks = chosen.breaks,
         filename = "teak_chm_density.pdf", width = 8, height = 6)

make_pdf(hist_plot_from_chm(reclassified.chm, 
                               title = "Canopy heights for NEON TeaKettle",
                               breaks = chosen.breaks,
         filename = "teak_chm_hist.pdf", width = 8, height = 6)










#here is a draft plot by class
plot(chm.class,
     main = "Teakettle Canopy Height By Class")

```



## STEP Five:  Export to .pdf!

```{r plot-to-pdf}

# plot outside of the plot region
# make room for a legend
par(xpd = FALSE, mar=c(5.1, 4.1, 4.1, 4.1))

#here, the xpd is saying "stay inside the corral, don't plot outside boundaries"
#bottom, up, left, right

# plot
pdf("outputs/chm.class.pdf", width = 6, height = 6)
plot(chm.class,
     col=c("grey","blue","green"), # hard code colors, small trees (1)=white,
		 #medium (2) = blue,  large trees (3) = green
     main="Vegetation Height \nLower Teakettle",
     legend=F)
# allow legend to plot outside of bounds
par(xpd=TRUE)

# legend x and y position
leg.x <- par()$usr[2] + 20
leg.y <- par()$usr[4] + 50 - (abs(par()$usr[3] - par()$usr[4]) / 2)

# create the legend
legend(leg.x, leg.y,
       legend = c("< 5 m", "5-20 m", "> 20 m"),  # make sure the order matches the colors, next
       fill = c("grey", "blue", "green"),
       bty="n") # turn off border)
dev.off()
# legend((par()$usr[2] + 20), 4103300,  # set x,y legend location
#        legend = c("    <5 m", "5-20 m", "  >20 m"),  # make sure the order matches the colors, next
#        fill = c("grey", "blue", "green"),
#        bty="n") # turn off border

```

## Step Six:  Export the raster

```{r export-raster}
writeRaster(chm.class,
            filename="outputs/Teak_nsAspect.tif",
            format="GTiff",
            options="COMPRESS=LZW",
            overwrite = TRUE,
            NAflag = -9999)


####This creates a great log session text file at the end!!!!!!
sink(paste0(format(Sys.time(), "%Y-%m-%d_%H%M%S"),
"_sessionInfo.txt"))     #zero after paste has no spaces
sessionInfo()
sink()
```